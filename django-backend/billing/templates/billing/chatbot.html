{% extends "billing/base.html" %}

{% block title %}DeloBot Assistant - Deloitte SLR{% endblock %}
{% block page_title %}DeloBot Assistant{% endblock %}

{% block content %}
<div class="chatbot-container">
    <div class="chatbot-header">
        <div class="chatbot-title">
            <div class="bot-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="bot-info">
                <h1>DeloBot Assistant</h1>
                <p>Votre assistant intelligent pour la gestion des ressources et missions</p>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Bonjour ! Je suis DeloBot, votre assistant Deloitte. Comment puis-je vous aider aujourd'hui ?</p>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une ressource')">
                            <i class="fas fa-user-plus"></i> Ajouter une ressource
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Modifier une ressource')">
                            <i class="fas fa-user-edit"></i> Modifier une ressource
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une mission')">
                            <i class="fas fa-plus-circle"></i> Ajouter une mission
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Modifier une mission')">
                            <i class="fas fa-edit"></i> Modifier une mission
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Voir dashboard')">
                            <i class="fas fa-chart-dashboard"></i> Voir le dashboard
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Aide')">
                            <i class="fas fa-question-circle"></i> Aide
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" placeholder="Tapez votre message..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Chatbot Container */
.chatbot-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header */
.chatbot-header {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 50%, #7CB342 100%);
    color: white;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(124, 179, 66, 0.3);
}

.chatbot-title {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
}

.bot-avatar {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.bot-info h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.bot-info p {
    font-size: 1.2rem;
    margin: 0.5rem 0 0;
    opacity: 0.9;
    font-weight: 300;
}

/* Chat Container */
.chat-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 200px);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 0;
}

/* Messages */
.message {
    display: flex;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.bot-message {
    justify-content: flex-start;
}

.user-message {
    justify-content: flex-end;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    margin-right: 0;
    margin-left: 1rem;
    order: 2;
}

.message-content {
    max-width: 70%;
    padding: 1rem 1.5rem;
    border-radius: 20px;
    position: relative;
}

.bot-message .message-content {
    background: #f8f9fa;
    border-bottom-left-radius: 5px;
    border: 1px solid #e9ecef;
}

.user-message .message-content {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
    border-bottom-right-radius: 5px;
}

.message-content p {
    margin: 0;
    line-height: 1.5;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}

.quick-action-btn {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    text-align: left;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(194, 235, 121, 0.4);
}

/* Action Links */
.action-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    margin: 0.5rem 0.5rem 0.5rem 0;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.action-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(194, 235, 121, 0.4);
    color: white;
    text-decoration: none;
}

/* Resource/Mission Lists */
.resource-item, .mission-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    margin: 0.5rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.resource-item:hover, .mission-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.item-details {
    color: #6c757d;
    font-size: 0.9rem;
}

.item-actions {
    display: flex;
    gap: 0.5rem;
}

.item-action-btn {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.item-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(194, 235, 121, 0.4);
    color: white;
    text-decoration: none;
}

/* Chat Input */
.chat-input-container {
    background: white;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

.chat-input-wrapper {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 50px;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
}

.chat-input-wrapper:focus-within {
    border-color: #C2EB79;
    box-shadow: 0 0 0 3px rgba(194, 235, 121, 0.2);
}

#chatInput {
    flex: 1;
    border: none;
    background: transparent;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    outline: none;
    color: #495057;
}

#chatInput::placeholder {
    color: #6c757d;
}

.send-btn {
    background: linear-gradient(135deg, #C2EB79 0%, #A8E063 100%);
    color: white;
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.1rem;
}

.send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(194, 235, 121, 0.4);
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-style: italic;
    animation: fadeIn 0.5s ease-in-out;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #C2EB79;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { opacity: 0.3; }
    30% { opacity: 1; }
}

/* Responsive Design */
@media (max-width: 768px) {
    .chatbot-title {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .bot-info h1 {
        font-size: 2rem;
    }
    
    .chat-container {
        padding: 1rem;
        height: calc(100vh - 160px);
    }
    
    .message-content {
        max-width: 85%;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Chat data and functions
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

// Données réelles depuis Django
const resources = {{ resources|safe }};
const missions = {{ missions|safe }};

function sendMessage() {
    const message = chatInput.value.trim();
    if (message) {
        addUserMessage(message);
        chatInput.value = '';
        processMessage(message);
    }
}

function sendQuickMessage(message) {
    addUserMessage(message);
    processMessage(message);
}

function addUserMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `
        <div class="message-content">
            <p>${message}</p>
        </div>
        <div class="message-avatar">
            <i class="fas fa-user"></i>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addBotMessage(content) {
    showTypingIndicator();
    
    setTimeout(() => {
        hideTypingIndicator();
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                ${content}
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }, 1000);
}

function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <p>DeloBot est en train de taper...</p>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function processMessage(message) {
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('ajouter') && lowerMessage.includes('ressource')) {
        addBotMessage(`
            <p>Parfait ! Pour ajouter une nouvelle ressource, cliquez sur le lien ci-dessous :</p>
            <a href="/resources/create/" class="action-link">
                <i class="fas fa-user-plus"></i> Ajouter une ressource
            </a>
        `);
    }
    else if (lowerMessage.includes('modifier') && lowerMessage.includes('ressource')) {
        let resourceList = '<p>Voici la liste des ressources disponibles pour modification :</p>';
        resources.forEach(resource => {
            resourceList += `
                <div class="resource-item">
                    <div class="item-info">
                        <div class="item-name">${resource.name}</div>
                        <div class="item-details">Matricule: ${resource.matricule} | Grade: ${resource.grade}</div>
                    </div>
                    <div class="item-actions">
                        <a href="/resources/${resource.id}/update/" class="item-action-btn">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                    </div>
                </div>
            `;
        });
        addBotMessage(resourceList);
    }
    else if (lowerMessage.includes('ajouter') && lowerMessage.includes('mission')) {
        addBotMessage(`
            <p>Excellent ! Pour ajouter une nouvelle mission, cliquez sur le lien ci-dessous :</p>
            <a href="/missions/create/" class="action-link">
                <i class="fas fa-plus-circle"></i> Ajouter une mission
            </a>
        `);
    }
    else if (lowerMessage.includes('modifier') && lowerMessage.includes('mission')) {
        let missionList = '<p>Voici la liste des missions disponibles pour modification :</p>';
        missions.forEach(mission => {
            missionList += `
                <div class="mission-item">
                    <div class="item-info">
                        <div class="item-name">${mission.name}</div>
                        <div class="item-details">Projet: ${mission.project} | OTP: ${mission.otp}</div>
                    </div>
                    <div class="item-actions">
                        <a href="/missions/${mission.id}/update/" class="item-action-btn">
                            <i class="fas fa-edit"></i> Modifier
                        </a>
                    </div>
                </div>
            `;
        });
        addBotMessage(missionList);
    }
    else if (lowerMessage.includes('dashboard') || lowerMessage.includes('tableau de bord')) {
        addBotMessage(`
            <p>Voici les liens vers les différents tableaux de bord :</p>
            <a href="/dashboard/" class="action-link">
                <i class="fas fa-chart-line"></i> Dashboard Principal
            </a>
            <a href="/dashboard/resources/" class="action-link">
                <i class="fas fa-users"></i> Tableau de Bord Ressources
            </a>
        `);
    }
    else if (lowerMessage.includes('aide') || lowerMessage.includes('help')) {
        addBotMessage(`
            <p>Je peux vous aider avec les actions suivantes :</p>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une ressource')">
                    <i class="fas fa-user-plus"></i> Ajouter une ressource
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Modifier une ressource')">
                    <i class="fas fa-user-edit"></i> Modifier une ressource
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une mission')">
                    <i class="fas fa-plus-circle"></i> Ajouter une mission
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Modifier une mission')">
                    <i class="fas fa-edit"></i> Modifier une mission
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Voir dashboard')">
                    <i class="fas fa-chart-dashboard"></i> Voir le dashboard
                </button>
            </div>
            <p>Tapez simplement ce que vous voulez faire, et je vous guiderai !</p>
        `);
    }
    else if (lowerMessage.includes('bonjour') || lowerMessage.includes('salut') || lowerMessage.includes('hello')) {
        addBotMessage(`
            <p>Bonjour ! Je suis ravi de vous aider. Je suis DeloBot, votre assistant intelligent pour la gestion des ressources et missions Deloitte.</p>
            <p>Comment puis-je vous assister aujourd'hui ?</p>
        `);
    }
    else {
        addBotMessage(`
            <p>Je ne suis pas sûr de comprendre votre demande. Voici ce que je peux faire pour vous :</p>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une ressource')">
                    <i class="fas fa-user-plus"></i> Ajouter une ressource
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Modifier une ressource')">
                    <i class="fas fa-user-edit"></i> Modifier une ressource
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Ajouter une mission')">
                    <i class="fas fa-plus-circle"></i> Ajouter une mission
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Aide')">
                    <i class="fas fa-question-circle"></i> Voir toutes les options
                </button>
            </div>
        `);
    }
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Auto-focus on input
document.addEventListener('DOMContentLoaded', function() {
    chatInput.focus();
});
</script>
{% endblock %}
